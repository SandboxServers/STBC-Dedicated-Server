# Server-Side Computation Model (2026-02-23)

Full analysis: [docs/analysis/server-side-computation-model.md](../../docs/analysis/server-side-computation-model.md)

## Key Finding: Stock BC dedi is a FULL SIMULATION, NOT a thin relay

| System | Server Computes? | Authority |
|--------|-----------------|-----------|
| Collision Damage | YES (validates proximity + recomputes damage pipeline) | SERVER |
| Weapon Damage | NO (each peer computes independently) | EACH PEER |
| StateUpdate | YES (reads live ship state, broadcasts at ~10Hz) | SERVER |
| Power System | YES (battery recharge + distribution on host) | SERVER |
| Repair System | YES (all peers tick; server generates authoritative events) | SERVER |
| Shield Recharge | YES (all peers tick; server corrects overall HP) | DUAL |
| PythonEvent | YES (repair/death events from server sim) | SERVER |
| Ship Physics | NO (trusts client StateUpdates) | CLIENT |

## Key Handler Behaviors

### FUN_006a2470 (CollisionEffect handler, opcode 0x15)
- NOT a blind relay; validates sender is source/dest of collision
- Checks bounding sphere proximity (distance - r1 - r2 < threshold)
- If valid: converts to HostCollisionEffectEvent (0x8000FC) -> local damage pipeline
- If invalid (too far apart or duplicate): DROPS the message

### FUN_0069fda0 (GenericEventForward, opcodes 0x07-0x12, 0x1B)
- RELAYS to "Forward" group (all clients)
- ALSO applies event locally to server's ship objects (if sender != host)
- Weapon damage computed independently by each peer (no server authority)

### FUN_0069f930 (TorpedoFire, opcode 0x19)
- RELAYS + creates torpedo object locally on server
- Each peer independently simulates torpedo flight + impact damage

### FUN_0069fbb0 (BeamFire, opcode 0x1A)
- RELAYS + applies beam effect locally on server
- Each peer independently computes beam damage

### FUN_005638d0 (Battery recharge)
- Gate: `(IsHost==0) OR (IsMultiplayer==1)` -> runs on dedi server
- Recharges main battery then backup battery per 1-second tick

### FUN_005652a0 (RepairSubsystem::Update)
- Runs on ALL peers (standalone, host, AND client in MP)
- Repair events (COMPLETED, CANNOT_COMPLETE) generated by server and sent as PythonEvent 0x06

### Shield recharge
- Runs via periodic timer events on ALL peers (event 0x8000006D)
- Per-facing HP NOT synchronized between peers
- Only overall shield condition synced via StateUpdate

## CRITICAL: Opcode 0x06 vs 0x0D Dispatch (2026-02-23)
- In dispatcher (0x0069f2a0), opcodes 0x06 and 0x0D share SAME case -> FUN_0069f880
- FUN_0069f880 = LOCAL-ONLY: deserialize event, post to EventManager, NO relay
- The RELAY handler (0x0069fda0) handles opcodes 0x07-0x12, 0x1B (NOT 0x06/0x0D)
- Server-generated events (HostEventHandler, ObjectExplodingHandler) are sent as opcode 0x06 to "NoMe" group BEFORE dispatch; receivers just apply locally
- Ghidra label "Handler_PythonEvent_0x06" at 0x0069fda0 is MISLEADING â€” it handles typed forwards, not opcode 0x06

## SendStateUpdates (FUN_0069ee50)
- Iterates all 16 player slots, skips host's own slot
- For each remote player: finds ship by baseObjID, calls WriteStateUpdate (vtable+0x120)
- Sends directly to each player's connID (NOT group broadcast)
- Called from MultiplayerGame per-tick Update; no explicit rate timer in this function
- Rate limiting is internal to WriteStateUpdate (dirty flags, round-robin budget)

## Architecture Pattern
BC uses "distributed simulation with server authority":
- ALL peers run full sim (damage, repair, power, shields)
- Server StateUpdate overrides client state (~10Hz)
- Weapon damage is the exception: fully peer-computed, can diverge
- NOT lockstep/deterministic; floating-point differences cause drift
- StateUpdate provides eventual consistency
